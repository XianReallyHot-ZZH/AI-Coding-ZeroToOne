# å½“å‰æ¶æ„åˆ†æ

## 1. é¡¹ç›®ç»“æ„

```
week02/db_query/backend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ api/                    # API è·¯ç”±å±‚
â”‚   â”‚   â”œâ”€â”€ databases.py        # æ•°æ®åº“è¿æ¥ç®¡ç†ç«¯ç‚¹
â”‚   â”‚   â””â”€â”€ query.py            # æŸ¥è¯¢æ‰§è¡Œç«¯ç‚¹
â”‚   â”œâ”€â”€ db/                     # æ•°æ®è®¿é—®å±‚
â”‚   â”‚   â”œâ”€â”€ models.py           # SQLAlchemy ORM æ¨¡å‹
â”‚   â”‚   â””â”€â”€ repository.py       # ä»“å‚¨ç±»
â”‚   â”œâ”€â”€ models/                 # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ database.py         # æ•°æ®åº“è¿æ¥ç›¸å…³æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ metadata.py         # å…ƒæ•°æ®å“åº”æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ query.py            # æŸ¥è¯¢ç›¸å…³æ¨¡å‹
â”‚   â”‚   â””â”€â”€ errors.py           # å¼‚å¸¸å®šä¹‰
â”‚   â”œâ”€â”€ services/               # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”‚   â”œâ”€â”€ connection.py       # è¿æ¥ç®¡ç†æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ metadata.py         # å…ƒæ•°æ®æå–æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ query.py            # æŸ¥è¯¢æ‰§è¡ŒæœåŠ¡
â”‚   â”‚   â””â”€â”€ nl_query.py         # è‡ªç„¶è¯­è¨€æŸ¥è¯¢æœåŠ¡
â”‚   â”œâ”€â”€ config.py               # é…ç½®ç®¡ç†
â”‚   â””â”€â”€ main.py                 # åº”ç”¨å…¥å£
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ test_mysql_integration.py
â”œâ”€â”€ data/
â”œâ”€â”€ pyproject.toml
â””â”€â”€ README.md
```

---

## 2. å½“å‰æ•°æ®åº“æ”¯æŒæ–¹å¼

### 2.1 æ•°æ®åº“ç±»å‹æ£€æµ‹ (ç¡¬ç¼–ç )

```python
# src/services/connection.py
def get_db_type(connection_url: str) -> str:
    """æ ¹æ®è¿æ¥URLåˆ¤æ–­æ•°æ®åº“ç±»å‹"""
    if connection_url.startswith(("mysql://", "mysql+pymysql://")):
        return "mysql"
    elif connection_url.startswith(("postgresql://", "postgres://")):
        return "postgresql"
    elif connection_url.startswith("sqlite://"):
        return "sqlite"
    return "unknown"
```

**é—®é¢˜**: æ¯æ·»åŠ æ–°æ•°æ®åº“ç±»å‹éœ€ä¿®æ”¹æ­¤å‡½æ•°ã€‚

### 2.2 URL éªŒè¯ (ç¡¬ç¼–ç )

```python
# src/models/database.py
class DatabaseConnectionCreate(BaseModel):
    connection_url: str

    @field_validator("connection_url")
    @classmethod
    def validate_url(cls, v: str) -> str:
        valid_prefixes = [
            "mysql://",
            "mysql+pymysql://",
            "postgresql://",
            "postgres://",
            "sqlite://",
        ]
        # ... éªŒè¯é€»è¾‘
```

**é—®é¢˜**: `valid_prefixes` åˆ—è¡¨éœ€æ‰‹åŠ¨ç»´æŠ¤ã€‚

### 2.3 SQL æ–¹è¨€æ˜ å°„ (åˆ†æ•£)

```python
# src/services/query.py
def _get_sqlglot_dialect(db_type: str) -> str:
    dialect_map = {
        "mysql": "mysql",
        "postgresql": "postgres",
        "postgres": "postgres",
        "sqlite": "sqlite",
    }
    return dialect_map.get(db_type, "sqlite")
```

**é—®é¢˜**: æ–¹è¨€æ˜ å°„åˆ†æ•£åœ¨å¤šä¸ªæœåŠ¡ä¸­ã€‚

### 2.4 å…ƒæ•°æ®æå– (æ¡ä»¶åˆ†æ”¯)

```python
# src/services/metadata.py
@classmethod
def extract_metadata(cls, db_name, connection_url, table_repo, column_repo):
    db_type = get_db_type(connection_url)

    # æ ¹æ®æ•°æ®åº“ç±»å‹å†³å®š schema è¿‡æ»¤
    if db_type == "mysql":
        # MySQL: åªæå–æŒ‡å®šæ•°æ®åº“çš„è¡¨
        schema_names = [connection_url.split("/")[-1].split("?")[0]]
    elif db_type == "postgresql":
        # PostgreSQL: åªæå– public schema
        schema_names = ["public"]
    else:
        # SQLite: æå–æ‰€æœ‰è¡¨
        schema_names = inspector.get_schema_names()
        # ...
```

**é—®é¢˜**: ä½¿ç”¨ if-elif åˆ†æ”¯å¤„ç†ä¸åŒæ•°æ®åº“ï¼Œè¿åå¼€é—­åŸåˆ™ã€‚

### 2.5 è‡ªç„¶è¯­è¨€æç¤ºè¯ (ç¡¬ç¼–ç )

```python
# src/services/nl_query.py
@classmethod
def get_system_prompt(cls, db_type: str) -> str:
    base_prompt = "..."
    if db_type == "mysql":
        return base_prompt + """
        - Use backticks (`) for identifier quoting
        - Use LIMIT for pagination
        """
    elif db_type == "postgresql":
        return base_prompt + """
        - Use double quotes for identifier quoting
        - Use LIMIT for pagination
        - Boolean values: true/false
        """
    # ...
```

**é—®é¢˜**: æç¤ºè¯é€»è¾‘ä¸ä¸šåŠ¡é€»è¾‘è€¦åˆã€‚

---

## 3. å½“å‰æ¶æ„ç—›ç‚¹æ€»ç»“

| ç—›ç‚¹ | ä½ç½® | å½±å“ | ä¸¥é‡ç¨‹åº¦ |
|------|------|------|----------|
| æ•°æ®åº“ç±»å‹æ£€æµ‹ç¡¬ç¼–ç  | `connection.py` | æ¯æ¬¡æ–°å¢éœ€ä¿®æ”¹ | ğŸ”´ é«˜ |
| URLå‰ç¼€éªŒè¯ç¡¬ç¼–ç  | `database.py` | æ¯æ¬¡æ–°å¢éœ€ä¿®æ”¹ | ğŸ”´ é«˜ |
| æ–¹è¨€æ˜ å°„åˆ†æ•£ | `query.py`, `nl_query.py` | ç»´æŠ¤å›°éš¾ | ğŸŸ¡ ä¸­ |
| å…ƒæ•°æ®æå–æ¡ä»¶åˆ†æ”¯ | `metadata.py` | ä»£ç è†¨èƒ€ | ğŸ”´ é«˜ |
| æç¤ºè¯ç¡¬ç¼–ç  | `nl_query.py` | ä¸å¯é…ç½® | ğŸŸ¡ ä¸­ |
| ç±»å‹åºåˆ—åŒ–ä¸å®Œæ•´ | `query.py` | å¯èƒ½ä¸¢å¤±æ•°æ® | ğŸŸ¢ ä½ |
| ç¼ºä¹é€‚é…å™¨æŠ½è±¡ | å…¨å±€ | éš¾ä»¥æ‰©å±• | ğŸ”´ é«˜ |

---

## 4. ç°æœ‰è®¾è®¡æ¨¡å¼åˆ†æ

### 4.1 å·²ä½¿ç”¨çš„æ¨¡å¼

| æ¨¡å¼ | åº”ç”¨ä½ç½® | æ•ˆæœ |
|------|----------|------|
| Repository Pattern | `db/repository.py` | âœ… è‰¯å¥½ |
| Service Layer Pattern | `services/` | âœ… è‰¯å¥½ |
| Dependency Injection | FastAPI Depends | âœ… è‰¯å¥½ |
| Factory Pattern | `ConnectionManager.get_engine()` | âš ï¸ éƒ¨åˆ† |
| Singleton Pattern | `_engines` ç±»å˜é‡ | âš ï¸ éƒ¨åˆ† |

### 4.2 ç¼ºå¤±çš„æ¨¡å¼

| æ¨¡å¼ | ç”¨é€” | ä¼˜å…ˆçº§ |
|------|------|--------|
| Strategy Pattern | æ•°æ®åº“ç‰¹å®šè¡Œä¸º | ğŸ”´ é«˜ |
| Adapter Pattern | ç»Ÿä¸€æ•°æ®åº“æ¥å£ | ğŸ”´ é«˜ |
| Registry Pattern | ç®¡ç†æ•°æ®åº“é€‚é…å™¨ | ğŸ”´ é«˜ |
| Template Method | å…ƒæ•°æ®æå–æµç¨‹ | ğŸŸ¡ ä¸­ |
| Plugin Architecture | å¤–éƒ¨é€‚é…å™¨æ”¯æŒ | ğŸŸ¢ ä½ |

---

## 5. æ·»åŠ æ–°æ•°æ®åº“çš„å½“å‰æ­¥éª¤

ä»¥æ·»åŠ  Oracle æ”¯æŒä¸ºä¾‹ï¼Œéœ€è¦ä¿®æ”¹ä»¥ä¸‹æ–‡ä»¶ï¼š

1. **`src/services/connection.py`**
   ```python
   # ä¿®æ”¹ get_db_type()
   elif connection_url.startswith(("oracle://", "oracle+cx_oracle://")):
       return "oracle"
   ```

2. **`src/models/database.py`**
   ```python
   # ä¿®æ”¹ valid_prefixes
   valid_prefixes = [..., "oracle://", "oracle+cx_oracle://"]
   ```

3. **`src/services/query.py`**
   ```python
   # ä¿®æ”¹ dialect_map
   dialect_map = {..., "oracle": "oracle"}
   ```

4. **`src/services/metadata.py`**
   ```python
   # æ·»åŠ æ–°çš„æ¡ä»¶åˆ†æ”¯
   elif db_type == "oracle":
       schema_names = inspector.get_schema_names()
       # Oracle ç‰¹å®šé€»è¾‘
   ```

5. **`src/services/nl_query.py`**
   ```python
   # æ·»åŠ  Oracle æç¤ºè¯
   elif db_type == "oracle":
       return base_prompt + "Oracle specific rules..."
   ```

6. **`pyproject.toml`**
   ```toml
   # æ·»åŠ ä¾èµ–
   dependencies = [..., "cx-oracle>=8.0.0"]
   ```

**æ€»è®¡**: éœ€è¦ä¿®æ”¹ **6 ä¸ªæ–‡ä»¶**ï¼Œæ¶‰åŠ **å¤šå¤„ä»£ç å˜æ›´**ã€‚

---

## 6. æœŸæœ›çš„æ·»åŠ æ–¹å¼

æ·»åŠ  Oracle æ”¯æŒ **åªéœ€**:

1. åˆ›å»º `src/adapters/oracle.py` æ–‡ä»¶
2. åœ¨ `src/adapters/__init__.py` ä¸­å¯¼å…¥
3. æ·»åŠ  `cx-oracle` ä¾èµ–

**æ— éœ€ä¿®æ”¹ä»»ä½•ç°æœ‰æ–‡ä»¶ï¼**

---

## 7. ç±»å›¾ - å½“å‰æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         API Layer                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚        databases.py          â”‚  â”‚       query.py          â”‚  â”‚
â”‚  â”‚  - create_connection()       â”‚  â”‚  - execute_query()      â”‚  â”‚
â”‚  â”‚  - list_connections()        â”‚  â”‚  - nl_to_sql()          â”‚  â”‚
â”‚  â”‚  - delete_connection()       â”‚  â”‚                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                             â”‚
                   â–¼                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Service Layer                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚     ConnectionManager        â”‚  â”‚     QueryService        â”‚  â”‚
â”‚  â”‚  + get_engine()              â”‚  â”‚  + validate_sql()       â”‚  â”‚
â”‚  â”‚  + test_connection()         â”‚  â”‚  + transform_sql()      â”‚  â”‚
â”‚  â”‚  + execute_query()           â”‚  â”‚  + execute_query()      â”‚  â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚
â”‚  â”‚  - get_db_type() â† ç¡¬ç¼–ç     â”‚  â”‚  - _get_sqlglot_dialect â”‚  â”‚
â”‚  â”‚  - normalize_mysql_url()     â”‚  â”‚    â† ç¡¬ç¼–ç              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚     MetadataService          â”‚  â”‚     NlQueryService      â”‚  â”‚
â”‚  â”‚  + extract_metadata()        â”‚  â”‚  + generate_sql()       â”‚  â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚
â”‚  â”‚  - if db_type == "mysql"     â”‚  â”‚  - get_system_prompt()  â”‚  â”‚
â”‚  â”‚  - elif db_type == "postgres"â”‚  â”‚    â† ç¡¬ç¼–ç              â”‚  â”‚
â”‚  â”‚  - else ... â† ç¡¬ç¼–ç          â”‚  â”‚                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                             â”‚
                   â–¼                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Data Access Layer                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   ConnectionRepository       â”‚  â”‚  TableMetadataRepo      â”‚  â”‚
â”‚  â”‚  + create()                  â”‚  â”‚  + create()             â”‚  â”‚
â”‚  â”‚  + get()                     â”‚  â”‚  + get_by_database()    â”‚  â”‚
â”‚  â”‚  + get_all()                 â”‚  â”‚  + delete_by_database() â”‚  â”‚
â”‚  â”‚  + delete()                  â”‚  â”‚                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é—®é¢˜**: æœåŠ¡å±‚åŒ…å«å¤§é‡ç¡¬ç¼–ç çš„æ•°æ®åº“ç±»å‹åˆ¤æ–­é€»è¾‘ã€‚
