# DB Query Backend 架构改进设计

## 概述

本文档描述了 `week02/db_query/backend` 项目的架构改进方案，旨在提供一套可扩展的接口设计，使得添加新的数据库类型时无需修改现有代码，完全符合 **Open-Close Principle (OCP)** 和 **SOLID 原则**。

---

## 文档索引

| 文档 | 描述 |
|------|------|
| [01-current-analysis.md](./01-current-analysis.md) | 当前架构分析 |
| [02-design-principles.md](./02-design-principles.md) | 设计原则与目标 |
| [03-interface-design.md](./03-interface-design.md) | 核心接口设计 |
| [04-adapter-pattern.md](./04-adapter-pattern.md) | 数据库适配器模式 |
| [05-registry-pattern.md](./05-registry-pattern.md) | 适配器注册机制 |
| [06-implementation-guide.md](./06-implementation-guide.md) | 实现指南 |
| [07-migration-plan.md](./07-migration-plan.md) | 迁移计划 |
| [08-examples.md](./08-examples.md) | 示例实现 |

---

## 核心改进目标

### 1. 开闭原则 (Open-Close Principle)
- **对扩展开放**: 添加新数据库类型只需新增适配器模块
- **对修改关闭**: 现有服务代码无需任何修改

### 2. 单一职责原则 (Single Responsibility Principle)
- 每个适配器只负责一种数据库类型
- 连接管理、元数据提取、查询执行职责分离

### 3. 依赖倒置原则 (Dependency Inversion Principle)
- 高层模块依赖抽象接口，不依赖具体实现
- 通过依赖注入获取适配器实例

### 4. 接口隔离原则 (Interface Segregation Principle)
- 接口按功能拆分，不强迫实现不需要的方法
- `ConnectionAdapter`、`MetadataAdapter`、`QueryAdapter` 分离

### 5. 里氏替换原则 (Liskov Substitution Principle)
- 所有数据库适配器可互相替换
- 行为一致性通过抽象基类保证

---

## 架构概览

```
┌─────────────────────────────────────────────────────────────────┐
│                         API Layer                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐   │
│  │ databases.py │  │   query.py   │  │    health.py         │   │
│  └──────┬───────┘  └──────┬───────┘  └──────────┬───────────┘   │
└─────────┼─────────────────┼─────────────────────┼───────────────┘
          │                 │                     │
          ▼                 ▼                     ▼
┌─────────────────────────────────────────────────────────────────┐
│                       Service Layer                              │
│  ┌──────────────────┐  ┌──────────────────┐  ┌───────────────┐  │
│  │ ConnectionService│  │   QueryService   │  │MetadataService│  │
│  └────────┬─────────┘  └────────┬─────────┘  └───────┬───────┘  │
└───────────┼─────────────────────┼────────────────────┼──────────┘
            │                     │                    │
            ▼                     ▼                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Adapter Interface Layer                       │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │              DatabaseAdapter (Abstract Base)                ││
│  │  ┌─────────────┐ ┌──────────────┐ ┌─────────────────────┐  ││
│  │  │IConnection  │ │ IMetadata    │ │ IQuery              │  ││
│  │  │Adapter      │ │ Adapter      │ │ Adapter             │  ││
│  │  └─────────────┘ └──────────────┘ └─────────────────────┘  ││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
            │                     │                    │
            ▼                     ▼                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Concrete Adapters Layer                       │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌───────────┐  │
│  │MySQLAdapter│  │SQLiteAdapt │  │PostgresAdpt│  │OracleAdapt│  │
│  └────────────┘  └────────────┘  └────────────┘  └───────────┘  │
└─────────────────────────────────────────────────────────────────┘
            │                     │                    │
            ▼                     ▼                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Infrastructure Layer                          │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                    SQLAlchemy Core                          ││
│  │  ┌─────────┐  ┌──────────┐  ┌───────────┐  ┌────────────┐  ││
│  │  │PyMySQL  │  │ aiosqlite│  │psycopg2   │  │cx_Oracle   │  ││
│  │  └─────────┘  └──────────┘  └───────────┘  └────────────┘  ││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
```

---

## 快速开始

### 添加新数据库支持只需 3 步

1. **创建适配器类** - 实现 `DatabaseAdapter` 接口
2. **注册适配器** - 在模块加载时自动注册
3. **安装驱动** - 添加必要的数据库驱动依赖

```python
# 1. 创建适配器 (adapters/oracle.py)
class OracleAdapter(DatabaseAdapter):
    @property
    def db_type(self) -> str:
        return "oracle"

    @property
    def connection_prefixes(self) -> list[str]:
        return ["oracle://", "oracle+cx_oracle://"]

    # ... 实现其他抽象方法

# 2. 注册适配器 (adapters/__init__.py)
from .oracle import OracleAdapter
adapter_registry.register(OracleAdapter())

# 3. 完成！无需修改任何现有代码
```

---

## 关键设计决策

| 决策 | 选择 | 理由 |
|------|------|------|
| 适配器模式 | 是 | 解耦数据库特定逻辑 |
| 注册表模式 | 是 | 动态发现和管理适配器 |
| 工厂模式 | 是 | 根据连接URL自动选择适配器 |
| 抽象基类 | 是 | 定义接口契约，提供默认实现 |
| 插件架构 | 是 | 支持外部适配器包 |
| 依赖注入 | 是 | FastAPI原生支持，便于测试 |

---

## 预期收益

1. **零修改扩展**: 添加新数据库只需新增文件
2. **职责清晰**: 每个类/模块职责单一
3. **易于测试**: 适配器可独立测试和模拟
4. **配置驱动**: 行为通过配置而非代码控制
5. **向后兼容**: 现有API和行为不受影响
